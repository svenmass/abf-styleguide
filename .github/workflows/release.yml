name: 🚀 ABF Styleguide Theme Release
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
    steps:
    - name: 🔄 Checkout Repository
      uses: actions/checkout@v4
    
    - name: 📝 Get Version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          echo "VERSION_NUMBER=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION_NUMBER=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        fi
        echo "📋 Version: $(echo ${GITHUB_REF#refs/tags/ } || echo ${{ github.event.inputs.version }})"
    
    - name: 📦 Create Theme ZIP
      run: |
        echo "🚀 Creating theme ZIP..."
        cd wp-content/themes
        
        # Copy development theme to production directory
        if [ ! -d "abf-styleguide-production" ]; then
          echo "📁 Creating production directory..."
          cp -r abf-styleguide abf-styleguide-production
        fi
        
        # Create ZIP from production theme
        zip -r "../../abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip" \
          abf-styleguide-production/ \
          -x "*.DS_Store*" "*node_modules*" "*.git*" "*.scss" "*package*.json" "*.md"
        
        cd ../..
        echo "✅ ZIP created: $(ls -lh abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip)"

    - name: 📋 Generate Release Notes
      run: |
        # Get the previous tag to compare changes
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        CURRENT_TAG=${{ steps.version.outputs.VERSION_NUMBER }}
        
        # Generate commit-based changelog
        echo "## 🎨 ABF Styleguide Theme $CURRENT_TAG" > release_notes.md
        echo "" >> release_notes.md
        
        if [ ! -z "$PREVIOUS_TAG" ]; then
          echo "### 📋 Änderungen seit $PREVIOUS_TAG:" >> release_notes.md
          echo "" >> release_notes.md
          
          # Get commits between tags and format them nicely
          git log --pretty=format:"- %s" --no-merges ${PREVIOUS_TAG}..HEAD | \
            grep -E "(🔧|✨|🐛|📱|🎨|🚀|♻️|💄|🌐|📝|⚡|🔒|🛠️)" | \
            head -10 >> release_notes.md
          
          echo "" >> release_notes.md
          echo "" >> release_notes.md
        else
          echo "### ✨ Features & Highlights:" >> release_notes.md
          echo "- Erste Release des ABF Styleguide Themes" >> release_notes.md
          echo "- 15+ vorgefertigte ACF-Blöcke" >> release_notes.md
          echo "- Typography CSS System mit responsive Schriftgrößen" >> release_notes.md
          echo "- Automatisches Update-System" >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        cat >> release_notes.md << EOF
        ### 📋 Installation:
        1. 📥 ZIP-Datei herunterladen
        2. 🎯 WordPress Admin → Designs → Design hochladen
        3. ✅ Theme aktivieren
        
        ### 🔄 Update:
        - **Automatisch:** Über WordPress Admin (wenn Auto-Updater aktiv)
        - **Manuell:** ZIP herunterladen und über WordPress installieren
        
        **Entwickelt mit ❤️ für ABF Corporate Design**
        EOF
        
        echo "📋 Dynamic release notes created"
        echo "--- Release Notes Preview ---"
        cat release_notes.md

    - name: 🚀 Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip"
        bodyFile: "release_notes.md"
        tag: ${{ steps.version.outputs.VERSION_NUMBER }}
        name: "ABF Styleguide Theme ${{ steps.version.outputs.VERSION_NUMBER }}"
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🎉 Release Summary
      run: |
        echo "## 🎉 Release Summary"
        echo "**Version:** ${{ steps.version.outputs.VERSION_NUMBER }}"
        echo "**ZIP Size:** $(ls -lh abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip | awk '{print $5}')"
        echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION_NUMBER }}"
        echo "✅ Release successfully created!"
