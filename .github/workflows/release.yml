name: ðŸš€ ABF Styleguide Theme Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version fÃ¼r manuelles Release (z.B. v1.2.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ·ï¸ Get Version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "ðŸ·ï¸ Building version: ${VERSION}"

    - name: ðŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ðŸ“¦ Install Dependencies
      working-directory: wp-content/themes/abf-styleguide
      run: |
        if [ -f "package.json" ]; then
          npm ci
          echo "âœ… Dependencies installed"
        else
          echo "âš ï¸ No package.json found, skipping"
        fi

    - name: ðŸŽ¯ Build Production Theme
      working-directory: wp-content
      run: |
        echo "ðŸš€ Building production theme..."
        
        # Set version in .theme-version file
        echo "${{ steps.version.outputs.VERSION_NUMBER }}" > .theme-version
        
        # Make scripts executable
        chmod +x production-cleanup.sh
        
        # Run manual build (simpler approach)
        export THEME_VERSION="${{ steps.version.outputs.VERSION_NUMBER }}"
        ./production-cleanup.sh
        
        echo "âœ… Production build completed"

    - name: ðŸ“ Create Theme ZIP
      working-directory: wp-content
      run: |
        THEME_NAME="abf-styleguide"
        VERSION="${{ steps.version.outputs.VERSION }}"
        ZIP_NAME="${THEME_NAME}-${VERSION}.zip"
        
        echo "ðŸ“¦ Creating ZIP: ${ZIP_NAME}"
        
        # Create clean theme directory
        mkdir -p release-temp
        cp -r themes/abf-styleguide-production release-temp/abf-styleguide
        
        # Create ZIP from the clean directory
        cd release-temp
        zip -r "../${ZIP_NAME}" abf-styleguide/ -x "*.DS_Store*" "*node_modules*" "*.git*" "*.scss" "*package*.json"
        cd ..
        
        # Cleanup
        rm -rf release-temp
        
        # Verify ZIP
        if [ -f "${ZIP_NAME}" ]; then
          ZIP_SIZE=$(du -h "${ZIP_NAME}" | cut -f1)
          echo "âœ… ZIP created successfully: ${ZIP_NAME} (${ZIP_SIZE})"
          echo "ZIP_FILE=${ZIP_NAME}" >> $GITHUB_ENV
          echo "ZIP_SIZE=${ZIP_SIZE}" >> $GITHUB_ENV
        else
          echo "âŒ ZIP creation failed"
          exit 1
        fi

    - name: ðŸ“ Generate Release Notes
      id: release_notes
      working-directory: wp-content
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        
        cat > release_notes.md << EOF
        # ðŸŽ¨ ABF Styleguide Theme ${VERSION}
        
        ## ðŸ“¦ Was ist neu?
        
        ### âœ¨ Features & Verbesserungen:
        - Production-optimierte Theme-Version
        - Kompilierte und komprimierte Assets
        - Alle Custom-Blocks enthalten
        - WordPress-kompatible Installation
        
        ### ðŸ› ï¸ Technische Details:
        - **Theme-Version:** ${VERSION}
        - **WordPress-kompatibel:** 6.0+
        - **PHP-Version:** 8.0+
        - **EnthÃ¤lt:** Alle ACF-Blocks, Styleguide, Assets
        
        ### ðŸ“‹ Installation:
        1. ðŸ“¥ ZIP-Datei herunterladen
        2. ðŸŽ¯ WordPress Admin â†’ Themes â†’ Theme hochladen
        3. ðŸ”„ Theme aktivieren
        4. âœ… Fertig!
        
        ### ðŸ”§ Automatische Updates:
        Dieses Theme unterstÃ¼tzt automatische Update-Benachrichtigungen.
        
        ---
        
        **ðŸ’¡ BenÃ¶tigen Sie Hilfe?** Kontaktieren Sie uns fÃ¼r Support.
        EOF

    - name: ðŸš€ Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.version.outputs.VERSION }}
        name: "ABF Styleguide Theme ${{ steps.version.outputs.VERSION }}"
        bodyFile: "wp-content/release_notes.md"
        artifacts: "wp-content/${{ env.ZIP_FILE }}"
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âœ… Release Summary
      run: |
        echo "ðŸŽ‰ Release completed successfully!"
        echo "ðŸ“¦ Version: ${{ steps.version.outputs.VERSION }}"
        echo "ðŸ’¾ File: ${{ env.ZIP_FILE }} (${{ env.ZIP_SIZE }})"
        echo "ðŸŒ Available at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
