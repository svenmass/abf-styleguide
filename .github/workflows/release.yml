name: ðŸš€ ABF Styleguide Theme Release
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ“ Get Version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          echo "VERSION_NUMBER=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION_NUMBER=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        fi
        echo "ðŸ“‹ Version: $(echo ${GITHUB_REF#refs/tags/ } || echo ${{ github.event.inputs.version }})"
    
    - name: ðŸ“¦ Create Theme ZIP
      run: |
        echo "ðŸš€ Creating theme ZIP..."
        cd wp-content/themes
        
        # Copy development theme to production directory
        if [ ! -d "abf-styleguide-production" ]; then
          echo "ðŸ“ Creating production directory..."
          cp -r abf-styleguide abf-styleguide-production
        fi
        
        # Create ZIP from production theme
        zip -r "../../abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip" \
          abf-styleguide-production/ \
          -x "*.DS_Store*" "*node_modules*" "*.git*" "*.scss" "*package*.json" "*.md"
        
        cd ../..
        echo "âœ… ZIP created: $(ls -lh abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip)"

    - name: ðŸ“‹ Generate Release Notes
      run: |
        # Get the previous tag to compare changes
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        CURRENT_TAG=${{ steps.version.outputs.VERSION_NUMBER }}
        
        # Generate commit-based changelog
        echo "## ðŸŽ¨ ABF Styleguide Theme $CURRENT_TAG" > release_notes.md
        echo "" >> release_notes.md
        
        if [ ! -z "$PREVIOUS_TAG" ]; then
          echo "### ðŸ“‹ Ã„nderungen seit $PREVIOUS_TAG:" >> release_notes.md
          echo "" >> release_notes.md
          
          # Get commits between tags and format them nicely
          git log --pretty=format:"- %s" --no-merges ${PREVIOUS_TAG}..HEAD | \
            grep -E "(ðŸ”§|âœ¨|ðŸ›|ðŸ“±|ðŸŽ¨|ðŸš€|â™»ï¸|ðŸ’„|ðŸŒ|ðŸ“|âš¡|ðŸ”’|ðŸ› ï¸)" | \
            head -10 >> release_notes.md
          
          echo "" >> release_notes.md
          echo "" >> release_notes.md
        else
          echo "### âœ¨ Features & Highlights:" >> release_notes.md
          echo "- Erste Release des ABF Styleguide Themes" >> release_notes.md
          echo "- 15+ vorgefertigte ACF-BlÃ¶cke" >> release_notes.md
          echo "- Typography CSS System mit responsive SchriftgrÃ¶ÃŸen" >> release_notes.md
          echo "- Automatisches Update-System" >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        cat >> release_notes.md << EOF
        ### ðŸ“‹ Installation:
        1. ðŸ“¥ ZIP-Datei herunterladen
        2. ðŸŽ¯ WordPress Admin â†’ Designs â†’ Design hochladen
        3. âœ… Theme aktivieren
        
        ### ðŸ”„ Update:
        - **Automatisch:** Ãœber WordPress Admin (wenn Auto-Updater aktiv)
        - **Manuell:** ZIP herunterladen und Ã¼ber WordPress installieren
        
        **Entwickelt mit â¤ï¸ fÃ¼r ABF Corporate Design**
        EOF
        
        echo "ðŸ“‹ Dynamic release notes created"
        echo "--- Release Notes Preview ---"
        cat release_notes.md

    - name: ðŸš€ Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip"
        bodyFile: "release_notes.md"
        tag: ${{ steps.version.outputs.VERSION_NUMBER }}
        name: "ABF Styleguide Theme ${{ steps.version.outputs.VERSION_NUMBER }}"
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸŽ‰ Release Summary
      run: |
        echo "## ðŸŽ‰ Release Summary"
        echo "**Version:** ${{ steps.version.outputs.VERSION_NUMBER }}"
        echo "**ZIP Size:** $(ls -lh abf-styleguide-${{ steps.version.outputs.VERSION_NUMBER }}.zip | awk '{print $5}')"
        echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION_NUMBER }}"
        echo "âœ… Release successfully created!"
